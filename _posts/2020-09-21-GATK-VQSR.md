---
 layout: post
 title: "GATK硬过滤和VQSR"
 description: "用之前合并的case数据分别进行进行VQSR和硬过滤，对比不同指标的结果"
 categories: [GWAS]
 tags: [GATK]
 redirect_from:
  - /2020/09/21/
---
 
 * Kramdown table of contents
 {:toc .toc}

# 前言
手上的GWAS数据量很大，gvcf合并一直还没运行结束，等待合并结束的过程中使用已经合并的case数据学习对比下VQSR和硬过滤的结果的差别。注：该文章仅作为个人学习总结,较多内容均出自阅读以下文章的理解。
## 参考文章

* [碱基矿工公众号：GATK4.0和全基因组数据分析实践（下）](https://mp.weixin.qq.com/s?__biz=MzAxOTUxOTM0Nw==&mid=2649798455&idx=1&sn=67a7407980a57ce138948eb46992b603&chksm=83c1d52bb4b65c3dde31df94e9686654bf616166c7311b531213ebf0010f67a32ce827e677b1&scene=21#wechat_redirect)

* [碱基矿工公众号：如何正确设置GATK VQSR的模型训练参数](https://zhuanlan.zhihu.com/p/40823886)该篇文章详细介绍了所用与训练模型的四大数据库，以VQSR训练模型的参数设置含义

* [官方教程：Variant Quality Score Recalibration (VQSR) ](https://gatk.broadinstitute.org/hc/en-us/articles/360035531612?id=39)

* [博客文章：GATK 4.0 WGS germline call variant](https://www.bioinfo-scrounger.com/archives/622/)

# 过程

## 硬过滤[^1]

> 硬过滤：通过认为设定一个或若干个指标阈值（特征值），把不满足阈值的变异位点采用一刀切的方法。</font color='red'>目前多采用GATK VQSR所用的指标 </font>VQSR使用的数据指标共有6个（在VCF的INFO域中）：
* QualByDepth (QD)
* FisherStrand (FS)
* StrandOddsRatio (SOR)
* RMSMappingQuality (MQ)
* MappingQualityRankSumTest (MQRankSum)
* ReadPosRankSunTest(ReadPosRankSum)

### 执行硬过滤

GATK4中的VaraintFiltration模块进行过滤，新建个文件夹hard_cut_output存放硬过滤的结果，VQSR_output用于存放VQSR结果
![](https://thumbnail0.baidupcs.com/thumbnail/98097627ckb7412f38ea932b5fa7d8a6?fid=1261248229-250528-479182591257260&rt=pr&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-LZ5CZwkxJMnzLnJhp20G4SiG%2fEk%3d&expires=8h&chkbd=0&chkv=0&dp-logid=6138012908631883351&dp-callid=0&time=1600671600&size=c10000_u10000&quality=90&vuk=1261248229&ft=image)

按照[碱基矿工公众号：GATK4.0和全基因组数据分析实践（下）](https://mp.weixin.qq.com/s?__biz=MzAxOTUxOTM0Nw==&mid=2649798455&idx=1&sn=67a7407980a57ce138948eb46992b603&chksm=83c1d52bb4b65c3dde31df94e9686654bf616166c7311b531213ebf0010f67a32ce827e677b1&scene=21#wechat_redirect)执行代码如下：

~~~ bash
# /bin/bash
#参数变量
outdir=/data/zhouying/gvcf_result/merge_test/hard_cut_output
indir=/data/zhouying/gvcf_result/merge_test
samplename=sample


# 使用SelectVariants，选出SNP
time gatk SelectVariants \
    -select-type SNP \
    -V $indir/${samplename}.raw.vcf \
    -O $outdir/${samplename}.snp.vcf.gz

# 为SNP作硬过滤
time gatk VariantFiltration \
    -V $outdir/${samplename}.snp.vcf.gz \
    --filter-expression "QD < 2.0 || MQ < 40.0 || FS > 60.0 || SOR > 3.0 || MQRankSum < -12.5 || ReadPosRankSum < -8.0" \
    --filter-name "PASS" \
    -O $outdir/${samplename}.snp.filter.vcf.gz

# 使用SelectVariants，选出Indel
time gatk SelectVariants \
    -select-type INDEL \
    -V $indir/${samplename}.raw.vcf \
    -O $outdir/${samplename}.indel.vcf.gz

# 为Indel作过滤
time gatk VariantFiltration \
    -V $outdir/${samplename}.indel.vcf.gz \
    --filter-expression "QD < 2.0 || FS > 200.0 || SOR > 10.0 || MQRankSum < -12.5 || ReadPosRankSum < -8.0" \
    --filter-name "PASS" \
    -O $outdir/${samplename}.indel.filter.vcf.gz

# 重新合并过滤后的SNP和Indel
time gatk MergeVcfs \
    -I $outdir/${samplename}.snp.filter.vcf.gz \
    -I $outdir/${samplename}.indel.filter.vcf.gz \
    -O $outdir/${samplename}.filter.vcf.gz

# 删除无用中间文件
rm -f $outdir/${samplename}.snp.vcf.gz* $outdir/${samplename}.snp.filter.vcf.gz* $outdir/${samplename}.indel.vcf.gz* $outdir/${samplename}.indel.filter.vcf.gz*
~~~

### 使用awk统计生成vcf的情况
第一次跑这个流程，为了理解处理过程，没有执行最后一步删除中间文件，保留了中间文件，通过awk、grep、wc等工具统计中间vcf的snp和indel条目

* 各中间文件记录数目
~~~ bash
less *.vcf |grep -v '^#'|wc -l >> variants_num.out
~~~

统计结果：

|raw|126400|
|snp|110653|
|snp_filter|110653|
|indel|15315|
|indel_filter|15315|
|merge_filter|125968|

可以看到SelectVariants和VariantFiltration所生成的vcf记录数目没有改变，为什么合并后数目发生变化？

* 各中间文件snp记录数目

~~~bash
#从SNP的原理来看是单个核苷酸的突变，那么理论上REF和ALT列均应该为单个核苷酸，故原理上统计命令行如下：
less sample.snp.vcf.gz | grep -v '^#'| awk '{if(length($4)==1 && length($5)==1) print}' | wc -l
~~~

统计结果：

|raw|110072|
|snp|110072|
|snp_filter|110072|
|indel|0|
|indel_filter|0|

按这个条件统计indel的vcf是0，但发现和gatk过滤得到的结果略有不同，通过一下命令行获取不同的的记录：

~~~bash
less sample.snp.vcf.gz | grep -v '^#'| awk '{if(length($4)!=1 || length($5)!=1) print}' >> other_snp.out
~~~

结果如下：
![](https://thumbnail0.baidupcs.com/thumbnail/6ea213d18kcd5442c77658a1bb4673e1?fid=1261248229-250528-1051334885209464&rt=pr&sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-n2AgTYsC8X7W7w%2fYzdG51E%2fyMz0%3d&expires=8h&chkbd=0&chkv=0&dp-logid=6140434776801345937&dp-callid=0&time=1600682400&size=c10000_u10000&quality=90&vuk=1261248229&ft=image)

共581条记录，刚好和gatk得到的snp.vcf一致，vcf了解到snp除了一碱基突变为另一个碱基的情况，多样本情况下可能出现突变成不同碱基的表示，通过‘，’分隔


## VQSR原理

### Overview

## 

[^1]:[碱基矿工公众号：GATK4.0和全基因组数据分析实践（下）](htt    ps://mp.weixin.qq.com/s?__biz=MzAxOTUxOTM0Nw==&mid=26497984    55&idx=1&sn=67a7407980a57ce138948eb46992b603&chksm=83c1d52b    b4b65c3dde31df94e9686654bf616166c7311b531213ebf0010f67a32ce    827e677b1&scene=21#wechat_redirect)
